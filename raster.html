<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <title>raster</title>

    <style media="screen">
      canvas {
        border: 1px solid #AAA;
      }
    </style>
  </head>

  <body>
    <script src="raster.js"></script>

    <script>
      'use strict';

      function hex2str(h) {
        //return (h*16 + 0x100000000).toString(16).substring(1);
        return hex2rgba(h).map(function(ch) { return (0x100 + ch).toString(16).substring(1); }).join('');
      }

      function str2hex(s) {
        return parseInt(s, 16);
      }

      function hex2rgba(h) {
        return [
          (h >> 24) & 255, // R
          (h >> 16) & 255, // G
          (h >>  8) & 255, // B
           h        & 255  // A
        ];
      }

      function rgba2hex(r, g, b, a) {
        return (
          (r << 24) +
          (g << 16) +
          (b <<  8) +
           a
        );
      }

      const W = 256;
      const H = 256;
      const canvasEl = document.createElement('canvas');
      canvasEl.width = W;
      canvasEl.height = H;
      document.body.appendChild(canvasEl);
      const ctx = canvasEl.getContext('2d');

      const id = ctx.getImageData(0, 0, W, H);

      let setPixel = function(x, y, c) {
        if (x < 0 || y < 0 || x >= W || y >= H) { return; }
        const channels = hex2rgba(c);
        //console.log(channels);
        let i = (W * y + x) * 4;
        id.data[i++] = channels[0];
        id.data[i++] = channels[1];
        id.data[i++] = channels[2];
        id.data[i  ] = channels[3];
      }

      const stroke = [ [0,0], [0,1], [1,0], [1,1] ];
      //const stroke = [ [-1,0], [0 0], [1,0], [0,-1], [0,1] ];
      const sp = setPixel;

      /*setPixel = function(x, y, c) {
        stroke.forEach(function(p) {
          sp(x+p[0], y+p[1], c);
        });
      }*/


      function getPixel(x, y) {
        let i = (W * y + x) * 4;
        const r = id.data[i++];
        const g = id.data[i++];
        const b = id.data[i++];
        const a = id.data[i  ];
        const h = rgba2hex(r, g, b, a);
        return h;
      }

      /*setPixel(0, 0, 0xFF0000FF);
      setPixel(2, 0, 0x00FF00FF);

      console.log( hex2str( getPixel(0, 0) ) );
      console.log( hex2str( getPixel(2, 0) ) );

      plotLine(0, 0, 255, 255, 0xFF0000FF);
      plotLine(160, 0, 155, 55, 0x000FF0FF);
      plotCircle(155, 100, 80, 0x0000FFFF);*/

      /*const curve = [
        [95, 108],
        [220, 33],
        [127, 40],
        [179, 35]
      ];
      plotQuadBezierCurve(curve, 0xFF00FFFF);
      curve.forEach(function(p) {
        setPixel(p[0], p[1], 0x000000FF);
      });*/



      /*function floodFill(x, y, c) {
        // x, y, width, height, test, paint
        const test = function(x, y) {
          const h = getPixel(x, y);
          const rgba = hex2rgba(h);
          //console.log('%s,%s => %s (%s %s)', x, y, h, hex2str(h), h, rgba.join(','));
          return !rgba[3];//v !== 0;
        };

        const paint = function(x, y) {
          setPixel(x, y, c);
        };

        floodFillScanline(x, y, W, H, test, paint);
      }

      floodFill(155, 100, 0xFF00FFFF);*/

      function rndInt(n) {
        return ~~(Math.random() * n);
      }

      const n = 3 + rndInt(4);
      const poly = [];
      const pi2 = Math.PI*2;
      for (let i = 0; i < n; ++i) {
        poly.push([
          ~~( W/2 + W/3*Math.cos(pi2/n*i) + rndInt(30)-15 ),
          ~~( H/2 + W/3*Math.sin(pi2/n*i) + rndInt(30)-15 )
        ]);
      }

      const c = rgba2hex(rndInt(255), rndInt(255), rndInt(255), 255);

      console.log(poly, hex2str(c));

      plotLines(poly, 0x777777FF, true);
      poly.forEach(function(p, i) {
        // str.charCodeAt(0) String.fromCharCode(n1, n2...)
        drawText(p[0]-1, p[1]-2, String.fromCharCode(65+i), 0x000000FF);
      });
      scanlinePolygonFill(poly, c);

      ctx.putImageData(id ,0, 0);
    </script>
  </body>
</html>
